import streamlit as st
import google.generativeai as genai
import markdown

# 1. Page Configuration (The Polish)
st.set_page_config(
    page_title="Story Grid Analyzer",
    page_icon="üìö",
    layout="wide",  # This uses the full screen width
    initial_sidebar_state="expanded"
)

# 2. Configure API
try:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
except:
    st.error("Missing API Key. Please check your Streamlit Secrets.")

# 3. The Brain (Analysis Function)
def analyze_story(story_text):
    prompt = """
    You are an expert Story Grid editor. Analyze the submitted scene and identify the 5 Commandments of Storytelling. 
    
    For each commandment, provide:
    1. The specific text/quote from the story that represents it.
    2. A brief explanation of why it fits that commandment.

    Please format your response as a structured report covering:
    
    1. **Inciting Incident** (Is it Causal or Coincidental?)
    2. **Turning Point** (Is it Action or Revelation? How does the value shift?)
    3. **Crisis** (Is it a Best Bad Choice or Irreconcilable Goods?)
    4. **Climax** (What is the active choice made?)
    5. **Resolution** (What is the new status quo?)

    Story text:
    """ + story_text
    
    model = genai.GenerativeModel('gemini-flash-latest')
    response = model.generate_content(prompt)
    return response.text

# 4. HTML Report Generator
def create_html_report(story_text, analysis_text):
    html_content = markdown.markdown(analysis_text)
    full_html = f"""
    <html>
    <head>
        <style>
            body {{ font-family: 'Helvetica', 'Arial', sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }}
            h1 {{ color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }}
            h2 {{ color: #e67e22; margin-top: 30px; }}
            strong {{ color: #2980b9; }}
            .story-box {{ background-color: #f9f9f9; border-left: 5px solid #ccc; padding: 15px; margin-bottom: 30px; font-style: italic; }}
            .footer {{ margin-top: 50px; font-size: 0.8em; color: #777; border-top: 1px solid #eee; padding-top: 10px; }}
        </style>
    </head>
    <body>
        <h1>Story Grid Analysis Report</h1>
        <h2>Original Scene</h2>
        <div class="story-box">{story_text[:500]}...</div>
        <h2>The 5 Commandments</h2>
        {html_content}
        <div class="footer">Generated by Story Grid Analyzer 2.0</div>
    </body>
    </html>
    """
    return full_html

# --- THE LAYOUT ---

# Sidebar (The Guide)
with st.sidebar:
    st.header("üìö Editor's Guide")
    st.markdown("""
    **The 5 Commandments** are the backbone of any working scene.
    
    ---
    
    **1. Inciting Incident**
    *The event that upsets the balance.*
    
    **2. Turning Point**
    *The action or revelation that shifts the value.*
    
    **3. Crisis**
    *The difficult choice (Best Bad Choice or Irreconcilable Goods).*
    
    **4. Climax**
    *The active choice the protagonist makes.*
    
    **5. Resolution**
    *The new status quo after the choice.*
    """)
    st.info("üí° **Tip:** Paste a complete scene (approx. 1000-2000 words) for the best results.")

# Main Area (The Workspace)
st.title("Story Grid Analyzer 2.0 üöÄ")
st.markdown("### ‚úçÔ∏è Scene Validator")

# Two columns: Input on left, Results on right (if you want side-by-side)
# For now, let's keep it stacked but wide
story_input = st.text_area("Paste your scene text below:", height=300, placeholder="It was a dark and stormy night...")

col1, col2 = st.columns([1, 4]) # Create a small column for the button
with col1:
    analyze_btn = st.button("üîç Analyze Scene", type="primary") # 'primary' makes it red/bold

if analyze_btn:
    if story_input:
        with st.spinner("Reading your story..."):
            try:
                report = analyze_story(story_input)
                
                # Visual Separator
                st.divider()
                st.subheader("üìù Analysis Report")
                st.markdown(report)
                
                # Download Button
                html_file = create_html_report(story_input, report)
                st.download_button(
                    label="üì• Download PDF/HTML Report",
                    data=html_file,
                    file_name="story_analysis.html",
                    mime="text/html"
                )
            except Exception as e:
                st.error(f"Error: {e}")
    else:
        st.warning("Please paste some text first.")