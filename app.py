import streamlit as st
import google.generativeai as genai
import markdown
import pandas as pd

# 1. SETUP
st.set_page_config(
    page_title="Story Grid Analyzer Pro",
    page_icon="üß¨",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- SECURITY ---
def check_password():
    if "password_correct" not in st.session_state:
        st.session_state.password_correct = False
    if st.session_state.password_correct:
        return True
    st.title("üîí Login Required")
    password = st.text_input("Enter Password", type="password")
    if st.button("Enter"):
        if password == "story2026": 
            st.session_state.password_correct = True
            st.rerun()
        else:
            st.error("üòï Incorrect password")
    return False

if not check_password():
    st.stop()

# --- SESSION STATE ---
if 'chapter_log' not in st.session_state:
    st.session_state.chapter_log = []
if 'current_report' not in st.session_state:
    st.session_state.current_report = ""

# --- API SETUP ---
try:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
except:
    st.error("‚ö†Ô∏è API Key missing. Please check Secrets.")

# --- HELPER: DOWNLOAD HTML ---
def create_html_report(content, title):
    # We add some extra CSS here to make sure lists look good
    html_content = markdown.markdown(content)
    return f"""
    <html>
    <head>
        <style>
            body {{ font-family: 'Helvetica', 'Arial', sans-serif; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }}
            h1 {{ color: #2c3e50; border-bottom: 2px solid #3498db; text-align: center; padding-bottom: 10px; }}
            h2 {{ color: #e67e22; margin-top: 30px; border-bottom: 1px solid #eee; padding-bottom: 5px; }}
            h3 {{ color: #2980b9; margin-top: 20px; }}
            ul {{ margin-bottom: 20px; }}
            li {{ margin-bottom: 8px; }}
            strong {{ color: #2c3e50; }}
            .footer {{ margin-top: 50px; font-size: 0.8em; color: #999; border-top: 1px solid #eee; padding-top: 10px; text-align: center; }}
        </style>
    </head>
    <body>
        <h1>{title}</h1>
        {html_content}
        <div class="footer">Generated by Story Grid Analyzer Pro</div>
    </body>
    </html>
    """

# --- BRAIN 1: SCENE ANALYZER ---
def analyze_scene(text, genre, framework, beat):
    prompt = f"""
    You are a ruthless Story Grid editor. Analyze this SCENE.
    STYLE: RUTHLESSLY CONCISE. Bullet points. Visual Scoreboard.
    
    CONTEXT: Genre: {genre} | Framework: {framework} | Beat: {beat}
    
    OUTPUT FORMAT:
    1. HEADER: "# [Emoji] [Start Value] ‚ûî [End Value]"
    2. THE 5 COMMANDMENTS (Bullet points)
    """
    if "None" not in framework:
        prompt += f"\n3. FRAMEWORK CHECK ({framework}): Verdict (‚úÖ PASS / ‚ùå FAIL) and 1 sentence reason."
    
    prompt += f"\n4. GENRE CHECK: Gold Star Moment üåü\n\nSTORY TEXT: {text}"
    
    model = genai.GenerativeModel('gemini-flash-latest')
    return model.generate_content(prompt).text

# --- BRAIN 2: OUTLINE DOCTOR (UPDATED FORMATTING) ---
def analyze_outline(text, genre, framework):
    # Common Style Guide for both options
    style_guide = """
    FORMATTING RULES:
    - Use Markdown Headers (##) for sections.
    - Use Bullet Points (*) for lists.
    - NEVER use pipes (|) to separate text.
    - Put each point on a NEW LINE.
    - Bold key terms.
    """

    if "None" not in framework:
        prompt = f"""
        Analyze this PLOT OUTLINE against {framework} structure.
        {style_guide}
        
        OUTPUT STRUCTURE: 
        ## üìä Structural Health Score: [Score]/10
        
        ## ü©∫ Gap Analysis
        (List the required beats of {framework}. Use a bullet list.)
        * **[Beat Name]:** [Status Emoji] - [Analysis]
        
        ## ‚ö° Pacing Check
        * [One clear sentence on pacing]
        """
    else:
        prompt = f"""
        Analyze this PLOT OUTLINE for Global 5 Commandments.
        {style_guide}
        
        OUTPUT STRUCTURE:
        ## üìä Narrative Arc Score: [Score]/10
        
        ## üåç Global 5 Commandments Check
        * **Inciting Incident:** [Status Emoji] - [Analysis]
        * **Turning Point:** [Status Emoji] - [Analysis]
        * **Crisis:** [Status Emoji] - [Analysis]
        * **Climax:** [Status Emoji] - [Analysis]
        * **Resolution:** [Status Emoji] - [Analysis]
        
        ## üí° Editor's Notes
        * [One clear sentence on what is missing]
        """
    prompt += f"\nOUTLINE TEXT: {text}"
    model = genai.GenerativeModel('gemini-flash-latest')
    return model.generate_content(prompt).text

# --- UI ---
st.title("Story Grid Analyzer Pro üß¨")

with st.sidebar:
    st.header("üéõÔ∏è Project Settings")
    st.caption("Logged in")
    selected_genre = st.selectbox("Genre", ["Action/Thriller", "Love Story", "Horror", "Mystery/Crime", "Sci-Fi/Fantasy", "Drama", "Non-Fiction"])
    selected_framework = st.selectbox("Structure Framework", ["None (Pure Story Grid)", "Save the Cat!", "Dan Harmon's Story Circle", "Fichtean Curve"])
    
    st.divider()
    st.markdown("### üóëÔ∏è Project Data")
    if st.button("Clear Project Table"):
        st.session_state.chapter_log = []
        st.success("Table cleared!")
        st.rerun()

# TABS
tab1, tab2 = st.tabs(["üî¨ Scene Logger", "ü©∫ Outline Doctor"])

# === TAB 1: SCENE LOGGER ===
with tab1:
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("### 1. Analyze Chapter")
        chapter_title = st.text_input("Chapter Name", placeholder="e.g. Chapter 1")
        
        beat_options = ["N/A"]
        if "Save the Cat" in selected_framework:
            beat_options = ["Opening Image", "Catalyst", "Debate", "Fun and Games", "All is Lost", "Finale"]
        elif "Story Circle" in selected_framework:
            beat_options = ["1. YOU", "2. NEED", "3. GO", "4. SEARCH", "5. FIND", "6. TAKE", "7. RETURN", "8. CHANGE"]
        
        if "None" not in selected_framework:
            selected_beat = st.selectbox("Beat", beat_options)
        else:
            selected_beat = "General Scene"

        scene_input = st.text_area("Paste Text:", height=200, key="scene_in")

        if st.button("üöÄ Analyze Scene", type="primary"):
            if scene_input:
                with st.spinner("Analyzing..."):
                    try:
                        report = analyze_scene(scene_input, selected_genre, selected_framework, selected_beat)
                        st.session_state.current_report = report
                        st.rerun()
                    except Exception as e:
                        st.error(f"Error: {e}")

    with col2:
        st.markdown("### 2. Review & Log")
        if st.session_state.current_report:
            st.info("Analysis Ready below ‚¨áÔ∏è")
            
            if st.button("‚ûï Add to Project Table"):
                new_entry = {
                    "Chapter": chapter_title,
                    "Beat": selected_beat,
                    "Verdict": "See Report", 
                    "Full Analysis": st.session_state.current_report
                }
                st.session_state.chapter_log.append(new_entry)
                st.success(f"Saved {chapter_title}!")
            
            html_report = create_html_report(st.session_state.current_report, f"Analysis: {chapter_title}")
            st.download_button(
                label="üì• Download Report",
                data=html_report,
                file_name=f"{chapter_title}_analysis.html",
                mime="text/html"
            )
        else:
            st.markdown("*Run analysis to see results.*")

    if st.session_state.current_report:
        st.markdown("---")
        st.markdown(st.session_state.current_report)

    st.markdown("---")
    st.subheader("üìä Project Table")
    if len(st.session_state.chapter_log) > 0:
        df = pd.DataFrame(st.session_state.chapter_log)
        st.dataframe(df, use_container_width=True)
        csv = df.to_csv(index=False).encode('utf-8')
        st.download_button("üì• Download CSV", csv, "novel_map.csv", "text/csv")
    else:
        st.caption("No chapters logged yet.")

# === TAB 2: OUTLINE DOCTOR ===
with tab2:
    st.markdown("### üöë Structural Health Check")
    if "None" not in selected_framework:
        st.info(f"Checking against **{selected_framework}** beats.")
    else:
        st.info("Checking for **Global 5 Commandments**.")
    
    outline_input = st.text_area("Paste Full Plot Outline:", height=300)
    
    if st.button("Diagnose Outline", type="primary"):
        if outline_input:
            with st.spinner("Diagnosing..."):
                try:
                    diagnosis = analyze_outline(outline_input, selected_genre, selected_framework)
                    st.markdown(diagnosis)
                    html_file = create_html_report(diagnosis, "Outline Health Report")
                    st.download_button("üì• Download Report", html_file, "outline_diagnosis.html", "text/html")
                except Exception as e:
                    st.error(f"Error: {e}")