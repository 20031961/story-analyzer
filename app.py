import streamlit as st
import google.generativeai as genai
import markdown

# 1. SETUP
st.set_page_config(
    page_title="Story Grid Analyzer Pro",
    page_icon="üß¨",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- SECURITY ---
def check_password():
    if "password_correct" not in st.session_state:
        st.session_state.password_correct = False
    if st.session_state.password_correct:
        return True
    st.title("üîí Login Required")
    password = st.text_input("Enter Password", type="password")
    if st.button("Enter"):
        if password == "story2026": 
            st.session_state.password_correct = True
            st.rerun()
        else:
            st.error("üòï Incorrect password")
    return False

if not check_password():
    st.stop()

# --- API SETUP ---
try:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
except:
    st.error("‚ö†Ô∏è API Key missing. Please check Secrets.")

# --- HELPER: CREATE DOWNLOADABLE HTML ---
def create_html_report(content, title):
    html_content = markdown.markdown(content)
    return f"""
    <html>
    <head>
        <style>
            body {{ font-family: 'Helvetica', 'Arial', sans-serif; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }}
            h1 {{ color: #2c3e50; border-bottom: 2px solid #3498db; text-align: center; }}
            h2 {{ color: #e67e22; margin-top: 25px; }}
            strong {{ color: #2980b9; }}
            .footer {{ margin-top: 40px; font-size: 0.8em; color: #999; border-top: 1px solid #eee; padding-top: 10px; text-align: center; }}
        </style>
    </head>
    <body>
        <h1>{title}</h1>
        {html_content}
        <div class="footer">Generated by Story Grid Analyzer Pro</div>
    </body>
    </html>
    """

# --- BRAIN 1: SCENE ANALYZER (Microscope) ---
def analyze_scene(text, genre, framework, beat):
    prompt = f"""
    You are a ruthless Story Grid editor. Analyze this SCENE.
    STYLE: Be concise. Bullet points. Visual Scoreboard at top.
    
    CONTEXT: Genre: {genre} | Framework: {framework} | Target Beat: {beat}
    
    OUTPUT FORMAT:
    1. HEADER: "# [Emoji] [Start Value] ‚ûî [End Value]"
    2. THE 5 COMMANDMENTS (Bullet points)
    3. FRAMEWORK CHECK: Verdict (‚úÖ PASS / ‚ùå FAIL) and 1 sentence reason.
    4. GENRE CHECK: Gold Star Moment üåü
    
    STORY TEXT: {text}
    """
    model = genai.GenerativeModel('gemini-flash-latest')
    return model.generate_content(prompt).text

# --- BRAIN 2: OUTLINE DOCTOR (Telescope) ---
def analyze_outline(text, genre, framework):
    prompt = f"""
    You are a master story architect. Analyze this PLOT OUTLINE.
    STYLE: Professional, structural diagnosis.
    
    CONTEXT: Genre: {genre} | Target Framework: {framework}
    
    TASK:
    Compare this user's outline against the structural beats of {framework}.
    
    OUTPUT FORMAT:
    1. **Structural Health Score:** (Score out of 10)
    2. **The Gap Analysis:**
       - List the required beats of {framework}.
       - For each beat, mark it ‚úÖ FOUND or ‚ùå MISSING/WEAK.
       - If missing, suggest ONE specific plot idea based on {genre}.
    3. **Pacing Check:** One sentence on flow.
    
    OUTLINE TEXT: {text}
    """
    model = genai.GenerativeModel('gemini-flash-latest')
    return model.generate_content(prompt).text

# --- UI ---
st.title("Story Grid Analyzer Pro üß¨")

# SIDEBAR
with st.sidebar:
    st.header("üéõÔ∏è Project Settings")
    st.caption("Logged in")
    selected_genre = st.selectbox("Genre", ["Action/Thriller", "Love Story", "Horror", "Mystery/Crime", "Sci-Fi/Fantasy", "Drama", "Non-Fiction"])
    selected_framework = st.selectbox("Structure Framework", ["Save the Cat!", "Dan Harmon's Story Circle", "Fichtean Curve"])

# TABS
tab1, tab2 = st.tabs(["üî¨ Scene Analyzer", "ü©∫ Outline Doctor"])

# === TAB 1: SCENE ANALYZER ===
with tab1:
    st.markdown("### Analyze a Single Chapter/Scene")
    
    beat_options = ["N/A"]
    if selected_framework == "Save the Cat!":
        beat_options = ["Opening Image", "Catalyst", "Debate", "Fun and Games", "All is Lost", "Finale"]
    elif selected_framework == "Dan Harmon's Story Circle":
        beat_options = ["1. YOU", "2. NEED", "3. GO", "4. SEARCH", "5. FIND", "6. TAKE", "7. RETURN", "8. CHANGE"]
    elif selected_framework == "Fichtean Curve":
        beat_options = ["Inciting Incident", "Rising Crisis", "Climax"]
    
    selected_beat = st.selectbox("Which Beat is this scene?", beat_options)
    scene_input = st.text_area("Paste Scene Text:", height=300, key="scene_in")
    
    if st.button("Analyze Scene", type="primary"):
        if scene_input:
            with st.spinner("Analyzing Scene..."):
                report = analyze_scene(scene_input, selected_genre, selected_framework, selected_beat)
                st.markdown(report)
                # Download
                html_file = create_html_report(report, "Scene Analysis")
                st.download_button("üì• Download Report", html_file, "scene_analysis.html", "text/html")

# === TAB 2: OUTLINE DOCTOR ===
with tab2:
    st.markdown("### üöë Structural Health Check")
    st.info(f"Paste your bulleted plot outline. The AI will check if it fits the **{selected_framework}** structure.")
    
    outline_input = st.text_area("Paste Full Plot Outline:", height=300, key="outline_in")
    
    if st.button("Diagnose Outline", type="primary"):
        if outline_input:
            with st.spinner(f"Measuring against {selected_framework}..."):
                diagnosis = analyze_outline(outline_input, selected_genre, selected_framework)
                st.markdown(diagnosis)
                # Download
                html_file = create_html_report(diagnosis, "Outline Diagnosis")
                st.download_button("üì• Download Diagnosis", html_file, "outline_diagnosis.html", "text/html")